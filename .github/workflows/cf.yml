name: cf workers

on:
  workflow_dispatch:

  push:
    branches:
      - master
    paths-ignore:
      - 'README.md'
      - 'LICENSE.md'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: cf
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust Toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown 
          
      # 1. Instal wasm-bindgen-cli ke versi yang kompatibel (0.2.106)
      - name: Install wasm-bindgen-cli 0.2.106
        run: cargo install -f wasm-bindgen-cli --version 0.2.106

      # Hapus langkah instalasi worker-build karena kita akan menjalankan wasm-bindgen secara manual.
      
      # 2. Kompilasi Rust ke Wasm
      - name: Build Rust to Wasm (Cargo)
        run: cargo build --release --target wasm32-unknown-unknown
        
      # 3. Jalankan wasm-bindgen secara manual
      # Output diarahkan ke './build/worker' dengan nama 'shim' untuk mengikuti konvensi 'worker-build'.
      - name: Generate JS Bindings (wasm-bindgen CLI)
        run: wasm-bindgen target/wasm32-unknown-unknown/release/siren.wasm --out-dir ./build/worker --target module --out-name shim --typescript
        
      # 4. Instal Wrangler versi 4 terbaru (mengatasi warning dan konflik)
      - name: Install Latest Wrangler v4
        run: npm install -g wrangler@4
        
      # 5. Hapus perintah build dari wrangler.toml (agar tidak terjadi double-build)
      - name: Remove build command from wrangler.toml
        run: sed -i '/^\[build\]$/,/^command/d' wrangler.toml

      # 6. Jalankan Deploy menggunakan npx Wrangler
      - name: Deploy
        run: npx wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          # Tambahkan variabel lingkungan penting lainnya (misalnya, CLOUDFLARE_ACCOUNT_ID) jika diperlukan
